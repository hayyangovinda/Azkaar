<div class="page-container">
  <header class="page-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
    </button>

  </header>

  <main class="content">
    <div class="adhkar-container" (swipeleft)="onSwipeLeft()" (swiperight)="onSwipeRight()">
      @for (dhikr of adhkar; track dhikr.arabic; let i = $index) {
      <div class="dhikr-group" [class.active]="currentIndex === i">
        <!-- Card 1: Arabic Text -->
        <div class="card arabic-card">
          <!-- <div class="card-number">{{ i + 1 }}</div> -->
          <div class="adhkar-label">Adhkar {{ i + 1 }}</div>
          @if (i === 0) {
          <div class="bismillah">أَعُوذُ بِاللهِ مِنَ الشَّيْطَانِ الرَّجِيمِ</div>
          } @else if (i >= 1 && i <= 3) {
          <div class="bismillah">بِسْمِ اللهِ الرَّحْمٰنِ الرَّحِيْمِ</div>
          } @else {
          <div class="bismillah-separator"></div>
          }
          <div class="arabic-text">{{ dhikr.arabic }}</div>
          <div class="repetition-indicator">
            @if (!showCheckmark[i]) {
            <div class="repetition-circle" (click)="onRepetitionClick(i)">
              @if (getCompletedCount(i) === 0) {
              <div class="initial-count">{{ dhikr.repetitions }}×</div>
              } @else {
              <div class="circle-content">
                <div class="progress-text">{{ getCompletedCount(i) }}/{{ dhikr.repetitions }}</div>
                @if (dhikr.repetitions > 1) {
                <svg class="progress-ring" width="70" height="70">
                  <circle class="progress-ring-bg" cx="35" cy="35" r="30" />
                  <circle class="progress-ring-fill" cx="35" cy="35" r="30"
                    [style.stroke-dasharray]="188.4"
                    [style.stroke-dashoffset]="188.4 - (188.4 * getProgressPercentage(i) / 100)" />
                </svg>
                }
              </div>
              }
            </div>
            } @else {
            <div class="repetition-circle checkmark">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            }
          </div>
        </div>

        <!-- Card 2: Translation (Collapsible) -->
        <div class="card translation-card">
          <button class="card-toggle" (click)="toggleTranslation(i)">
            <span class="card-title">Translation</span>
            <svg class="toggle-icon" [class.expanded]="translationExpanded[i]" xmlns="http://www.w3.org/2000/svg"
              width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          @if (translationExpanded[i]) {
          <div class="card-content">
            <p>{{ dhikr.translation }}</p>
          </div>
          }
        </div>

        <!-- Card 3: Transliteration (Collapsible) -->
        <div class="card transliteration-card">
          <button class="card-toggle" (click)="toggleTransliteration(i)">
            <span class="card-title">Transliteration</span>
            <svg class="toggle-icon" [class.expanded]="transliterationExpanded[i]" xmlns="http://www.w3.org/2000/svg"
              width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          @if (transliterationExpanded[i]) {
          <div class="card-content">
            <p>{{ dhikr.transliteration }}</p>
          </div>
          }
        </div>

        <!-- Card 4: Sources (Collapsible) -->
        @if (dhikr.sources && dhikr.sources.length > 0) {
        <div class="card sources-card">
          <button class="card-toggle" (click)="toggleSources(i)">
            <span class="card-title">Sources</span>
            <svg class="toggle-icon" [class.expanded]="sourcesExpanded[i]" xmlns="http://www.w3.org/2000/svg" width="20"
              height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          @if (sourcesExpanded[i]) {
          <div class="card-content">
            <ul>
              @for (source of dhikr.sources; track source) {
              <li>{{ source }}</li>
              }
            </ul>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
  </main>

  <!-- Review Prompt Modal -->
  @if (showReviewPrompt) {
  <div class="modal-overlay" (click)="declineReview()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2 class="modal-title">Enjoying Azkaar?</h2>
      <p class="modal-message">
        Would you like to rate us on the Play Store? Your feedback helps us improve and reach more people!
      </p>
      <div class="modal-actions">
        <button class="modal-button secondary" (click)="declineReview()">Not Now</button>
        <button class="modal-button primary" (click)="acceptReview()">Rate App</button>
      </div>
    </div>
  </div>
  }
</div>